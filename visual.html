<!DOCTYPE html>
<style type="text/css">
*{
	margin:0;
	padding:0;
	list-style:none;

}
.mapClicked{
	fill: #b5e3e5; stroke: #a9cbce; stroke-width : 0.5;
}
.mapNotClicked{
	fill: #e6f3f4; stroke: #a9cbce; stroke-width : 0.65;
}	
.circleClicked{
	fill: #ccccff; stroke: #fff; stroke-width : 0.3; 
}

.circleNotClicked{
	fill: #014e66; stroke: #fff; stroke-width : 0.2; 
}
.mapHovered{
	fill: #c7ebed;

}

.circleHighlighted{
	fill: #ff6666; stroke: #fff ; stroke-width : 0.3; 
}
.circleDrawn{
	fill: #ff6666; 
}
.circleDrawn_int{
	fill: #6542f4;
}
.circleFiltered{
	fill: #f4523d; stroke: #fff; stroke-width : 0.3; 
}
.intersected{
	fill: #6542f4;stroke: #fff; stroke-width : 0.3; 
}

.axis .halo {
  stroke: gray;
  stroke-width: 4px;
  stroke-linecap: round;
}

.slider .handle path {
  stroke: white;
  stroke-width: 3px;
  stroke-linecap: round;
  pointer-events: none;
}

.transparent{
	opacity : 0.13;
}
.transparent2{
	opacity : 0.5;
}
.circleWrapper{
	float:left;
	width:60px;
	height: 100%;
}
.timeWrapper{
	float:left;
	width: calc(100% - 60px);
	height:100%;
}
</style>


<html style ="height:100%">

<head>
	<title></title>
</head>
<body style ="height: 100%; margin: 0; font-size:11px">
<div id = 'main' style="width:72%; height:100%; float:left; overflow:hidden;"></div>

<div id = 'board' style = "width:27.3%; height:100%; float:left; background: #fff; overflow:auto; border-left: 1px solid #e5e2e2;">
	<div id = 'board_header' style = "width:100%; height:60px"></div>
	<div id = 'board_text' style = "width:100%; height: 30px"></div>
	<div id = 'board_time' style = "width:100%; height: calc(85% - 90px); overflow:auto"></div>
	<div id = 'board_info' style = "width:100%; height: 15%;"></div>	

</div>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-zoom.v1.min.js"></script>

<!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
<script src="https://d3js.org/d3-time-format.v2.min.js"></script>
<script type="text/javascript">


var width = 1920; var height = 1000;
// var margin = {top: 20, bottom: 20, left: 20, right: 20};
var timeFormat = d3.timeFormat("%Y %b");
var circle_clicked = false;
var map_clicked = 0;
var dflt_radius = 1.5;
var parseTime = d3.timeParse("%Y-%m")


var zoom = d3.zoom()
    .scaleExtent([1, 10])
    .on("zoom", zoomed);


// var zoom = d3.behavior.zoom()
// 		   .scaleExtent([1,5])
// 		   .on("zoom", moveAndZoom);
	
var svg = d3.select('#main').append('svg')
	.attr('width', '100%')
	.attr('height', '100%')
	// .attr('fill','blue')
	.call(zoom);

var g_map = svg.append('g')
	// .attr('width', width)
	// .attr('height', height)		
	// .attr('fill', 'blue');

// var g_board = svg.append('g')
//     .attr('width', 500)
//     .attr('height', height);
	
var boardSVG_circle = d3.select('#board_time').append('div').attr('class','circleWrapper').append('svg').attr('height','100%').attr('width','100%').style('overflow','auto').attr('id','boardCircle');
var boardSVG = d3.select('#board_time').append('div').attr('class','timeWrapper').append('svg').attr('height', '100%').attr('width', '100%').style('overflow','auto').attr('id','boardMain');


var bm_width = d3.select('#boardMain').style('width').replace('px','');
var bm_height = d3.select('#boardMain').style('height').replace('px','');

var projection = d3.geoMercator()
	.scale(265)
	.center([0, 35])
	.translate([width/2 -150 , height/2]);
var path = d3.geoPath().projection(projection);

var timeScale = d3.scaleTime()
  .domain([new Date('1946-03'), new Date('1991-12')])
  .range([0, bm_width - 50])
  // .clamp(true);

var timeZoom = d3.zoom().scaleExtent([1, 10]).translateExtent([[-bm_width*0.1, -Infinity], [bm_width*0.93, Infinity]])
      .on('zoom', timeZoomed )





var timeZoomBox = boardSVG.append('rect').classed('timezoom',true).attr('y',50).attr('width',bm_width-50).attr('height',bm_height).style('visibility','invisible').style('fill-opacity', 0.1).call(timeZoom);




var timeAxis = d3.axisTop(timeScale).ticks(4)
			   .tickFormat(timeFormat).tickSize(0).tickPadding(12)
			   // .tickValues([timeScale.domain()[0], timeScale.domain()[1]]);

var startValue = timeScale(new Date('1946-03'));
startingValue = new Date('1946-03');

var brush = d3.brushX()
	.extent([[0,15],[bm_width- 30,bm_height]])
    .on("brush", brushed);

var sliderSVG = boardSVG.append('svg').attr('class', 'slider').attr('width','100%').attr('height', 80);

var brushableG = boardSVG.append('g').classed('brushable',true).call(brush);

var axisG = boardSVG.append('g').attr('class', 'x axis').attr('transform','translate(0, 50)').call(timeAxis);

var timeTextG = d3.select('#board_text').append('svg').attr('width',
	'100%').attr('height','100%').classed('timeText',true);

timeTextG.append('text').text('Drag right below to set a time filter.').attr('x',20).attr('y',20);

d3.select('.overlay').attr('width', bm_width-30).attr('height', 50);

var newScale,
    range,
    storedValue = [0, bm_width - 50];

var timeRectsG = boardSVG.append('g').classed('timeRects',true)

var tooltip = d3.select('body').append('div').attr('class','tooltip').style('opacity', 0);

queue()
	.defer(d3.json, "/public/worldmap.geojson")//world map
	.defer(d3.csv, "/public/MIDB_4.01.csv")//base data
	.defer(d3.csv, "/public/MIDA_4.01.csv")//additional data
	.defer(d3.csv, "/public/MIDLOC_1.1.csv")//additional data2
	.await(function(error,mapData, csv_1, csv_2, csv_3){

var data = d3.nest().key(function(d){ return d.DispNum3;})
			 .entries(csv_1)
var data_2 = csv_2, 
	data_3 = csv_3;

console.log(mapData)
// console.log(data);
// console.log(data_2);
// console.log(data_3);

for (var i = 0; i<= data.length-1; i++){

		data[i].countries_A = [];
		data[i].countries_B = [];
		for(var j = 0; j <= data[i].values.length-1; j++){
			// console.log(data[i].values[j].ccode);
			if(data[i].values[j].SideA == 1){
				data[i].countries_A.push(data[i].values[j].ccode);
			}
			else{
				data[i].countries_B.push(data[i].values[j].ccode);	
			}
		}
		data[i].DispNum = data_2[i].DispNum3;
		data[i].StYear = data_2[i].StYear;
		data[i].StMon = data_2[i].StMon;
		data[i].EndYear = data_2[i].EndYear;
		data[i].EndMon = data_2[i].EndMon;
		data[i].lat = data_3[i].latitude
		data[i].lon = data_3[i].longitude;
		data[i].Start = data[i].StYear + '-' + data[i].StMon
		data[i].End = data[i].EndYear + '-' + data[i].EndMon
		// data[i].clicked = false
		// data[i].highlighted = false
		
		delete data[i].key;
		delete data[i].values;
	}

console.log(data);

var features = mapData.features.filter(function(d){return d.properties.COWCODE !== -1 && !(d.properties.COWCODE == 365 && (d.properties.COWEYEAR ==1991))});
	
for (var i = 0; i <= features.length-1; i++){
	features[i].clicked = false;
	features[i].highlighted = false;
}
	
var map_path = g_map.selectAll('path').data(features).enter().append('path')
		.attr('d', path)
		.attr('vector-effect', 'non-scaling-stroke')
		.classed('mapNotClicked', true)
		.on('mouseover', mouseoverMap)
		.on('mouseout', mouseoutMap)
		.on('click', selectMap)
		// .on('click', );

var circles = g_map.selectAll('circle')
			 .data(data)
			 .enter()
			 .append('circle')
			 
			 .attr('cx', (d)=> projection([d.lon,d.lat])[0])
			 .attr('cy', (d)=> projection([d.lon,d.lat])[1])
			 .attr('r', 0)
			 .classed('circleNotClicked', true)
			 .on('mouseover', mouseoverCircle)
			 .on('mouseout', mouseoutCircle)
			 .on('click', selectCircle)
			 .transition()
			 .delay((d, i) => i*0.2)
			 .duration(1000)
			 .attr('r', 3.5)
			 .transition()
			 .duration(500)
			 .attr('r', dflt_radius);
			 // .attr('class', 'circleNotClicked');

})


function mouseoverMap(d){
  // Highlight hovered province
  if (!d3.select(this).classed('mapClicked') && !d3.select(this).classed('mapHighlighted') ){
   d3.select(this).classed('mapHovered', true );

  }
    console.log(d)
  // Draw effects
}

function mouseoutMap(d){
	if (!d3.select(this).classed('mapClicked') && !d3.select(this).classed('mapHighlighted')){
	d3.select(this).classed('mapHovered', false ).classed('mapNotClicked',true);
	}
  
}

function mouseoverCircle(d){

   d3.select(this).attr('r', 3.5);

}


function mouseoutCircle(d){

	if(d3.select(this).classed('circleHighlighted') || d3.select(this).classed('circleClicked') || d3.select(this).classed('intersected')){
		d3.select(this).attr('r', 3);
	}
	else{
		d3.select(this).attr('r', dflt_radius);
	}
  
}

function selectCircle(d){

	if (!circle_clicked ){
	 g_map.selectAll('path').attr('class', null).classed('mapNotClicked',true);
	 highlight(d.countries_A, d.countries_B)
	 console.log("DispNum", d.DispNum)
	 console.log("countriesA", d.countries_A)
	 console.log("countriesB",d.countries_B);

	 d3.selectAll('circle').attr('style',null).attr('class', null).classed('circleNotClicked', true).attr('r', dflt_radius);
	 d3.select(this).attr('style', null).classed('circleNotClicked', false).classed('circleClicked', true).attr('r', 3);
	 console.log(this);
	 circle_clicked = true;
	}
	else{
		g_map.selectAll('path').attr('style', null).classed('mapNotClicked', true).
		classed('mapClicked', false).classed('mapHighlighted', false);
		d3.selectAll('circle').attr('style',null).attr('class',null).classed('circleNotClicked', true).attr('r', dflt_radius);
		circle_clicked = false;

	}

}

function selectMap(d){

var fltr_circles = g_map.selectAll('circle').filter(function (d_){
	return include(d_.countries_A, d.properties.COWCODE) ||
	  	   include(d_.countries_B, d.properties.COWCODE)});

	

			if (circle_clicked ){
				g_map.selectAll('path').attr('style', null).classed('mapNotClicked', true).
				classed('mapClicked', false).classed('mapHighlighted', false);
				d3.selectAll('circle').attr('style',null).attr('class',null).classed('circleNotClicked', true).attr('r', dflt_radius);
				circle_clicked = false;
				d.clicked = false;
				
			}
				
			else {

				if (map_clicked == 0){

						 
							// console.log(this)
							d3.select(this).attr('style', null).attr('class', null).classed('mapClicked', true);
						
							
							fltr_circles.attr('style',null).attr('class',null).classed('circleHighlighted', true).transition().attr('r',3);
							// d3.selectAll('.circleNotClicked').classed('transparent2',true);
							console.log("fltr",fltr_circles);
							d.clicked = true;
							map_clicked = 1
							// console.log(d)
							drawCircle();
							// brush.extent()
	
				}

				else{

					if(map_clicked == 1){

						if(!d3.select(this).classed('mapClicked'))
						{
							d3.select(this).attr('style', null).attr('class', null).classed('mapClicked', true);
							d.clicked = true;
							fltr_circles.filter(function(d){return d3.select(this).classed('circleHighlighted')}).attr('class',null).classed('intersected',true).transition().attr('r',2).transition().attr('r',3);
							d3.selectAll('.circleHighlighted').attr('class', null).classed('circleNotClicked',true).attr('r',dflt_radius);	
							// fltr_circles[0].filter(function(d){return d3.select(this).classed('circleHighlighted') }).attr('class',null).attr('style',null).classed('circleNotClicked', true);
							map_clicked = 2;
							drawCircle();
						}
						else{

							d.clicked = false
							d3.select(this).attr('style', null).classed('mapNotClicked', true).classed('mapClicked',false);

							fltr_circles.attr('r', dflt_radius);
							fltr_circles.attr('class', null).classed('circleNotClicked', true);
							// d3.selectAll('.circleNotClicked').classed('transparent2', false);
							map_clicked = 0;
							removeCircle();


						}
					}
				    else{

				    	g_map.selectAll('path').attr('style', null).classed('mapNotClicked', true).
						classed('mapClicked', false).classed('mapHighlighted', false);
						g_map.selectAll('circle').attr('style',null).attr('class',null).classed('circleNotClicked', true).attr('r', dflt_radius);
						boardSVG_circle.selectAll('circle').remove();
						timeRectsG.selectAll('rect').remove();
						circle_clicked = false;
						d.clicked = false;
						map_clicked = 0;


				    }		
				}		
			}
	}


function highlight(a,b){
	g_map.selectAll('path').filter(
		function(d){ return include(a, d.properties.COWCODE)})
		.style('fill','blue').classed('mapHighlighted', true);
	g_map.selectAll('path').filter(
		function(d){ return include(b, d.properties.COWCODE)})
		.style('fill', 'red').classed('mapHighlighted', true);

}

function include(arr, obj) {
    for(var i=0; i<=arr.length-1; i++) {
        if (arr[i] == obj) return true;
    }
}

function zoomed() {
  g_map.attr('transform',d3.event.transform);
}


function drawCircle(){

	var selectedCircles;

	if (map_clicked == 1){

		selectedCircles = d3.selectAll('.circleHighlighted')
		boardSVG_circle.attr('height', function(d){return selectedCircles.data().length*40.2});
		boardSVG.attr('height', function(d){return selectedCircles.data().length*40.2});
		d3.select('.timezoom').attr('height', function(d){return selectedCircles.data().length*40.2} )

		

		boardSVG_circle.selectAll('circle').data(selectedCircles.data().sort(sortByDateAscending)).enter().append('circle').classed('circleDrawn',true).attr('cx', 30).attr('cy', function(d,i){return i*40 + 70} ).attr('r',0).attr('fill', '#ff6666').transition()
				 .delay((d, i) => i*10)
				 .duration(1000)
				 .attr('r', 12);

		timeRectsG.selectAll('rect')
		.data(selectedCircles.data().sort(sortByDateAscending))
		.enter()
		.append('rect')
		.attr('x', function(d){return newScale==undefined ? timeScale(parseTime(d.Start)) : newScale(parseTime(d.Start))})
		// .attr('y', )
		.attr('width', 0)
		.attr('y', function(d,i){return i*40 + 60})
		.transition()
		.delay((d,i) => i*50)
		.duration(700)
		.attr('width',
			 function(d){return newScale == undefined? timeScale(parseTime(d.End)) - timeScale(parseTime(d.Start)) : newScale(parseTime(d.End)) - newScale(parseTime(d.Start))})
		
		.attr('height', 24)
		 

		}

	else{

		selectedCircles = d3.selectAll('.intersected')
		var data_intersected = selectedCircles.data()

		console.log(data_intersected);

		var newBind_circle = boardSVG_circle.selectAll('circle').data(data_intersected, function(d){return d.DispNum});

		newBind_circle.exit().transition().attr('r', 0).remove();
		newBind_circle.transition().duration(1000).attr('cy', function(d,i){ return i * 40 + 70}).style('fill', '#6542f4' );

		// boardSVG_circle.selectAll('.circleDrawn').remove();

		// selectedCircles = d3.selectAll('.intersected')
		// boardSVG_circle.attr('height', function(d){return selectedCircles.data().length*40.2});
		// boardSVG.attr('height', function(d){return selectedCircles.data().length*40.2});
		// d3.select('.timezoom').attr('height', function(d){return selectedCircles.data().length*40.2} )

		// boardSVG_circle.selectAll('circle').data(selectedCircles.data().sort(sortByDateAscending)).enter().append('circle').classed('circleDrawn_int',true).attr('cx', 30).attr('cy', function(d,i){return i*40 + 70} ).attr('r',0).attr('fill', '#ff6666').transition()
		// 		 .delay((d, i) => i*20)
		// 		 .duration(1000)
		// 		 .attr('r', 12);

		// timeRectsG.selectAll('rect').remove();

		var newBind_rect = timeRectsG.selectAll('rect').data(data_intersected, function (d){return d.DispNum});

		newBind_rect.exit().transition().attr('width', 0).remove();
		newBind_rect.transition().duration(1000).attr('y',function(d,i){
			return i * 40 + 60})
		}

	

	// console.log(selectedCircles.data().sort(sortByDateAscending));

	brushableG.select('.selection').style('height', selectedCircles.data().length*40.2 );
	brushableG.select('.handle').style('height', selectedCircles.data().length*40.2 );

	brush.extent([[0,15],[bm_width-30, selectedCircles.data().length*40.2]]);
	brushableG.call(brush);

	d3.select('.overlay').attr('width', bm_width-30).attr('height', 50);

	
	// var displayedCircles = d3.select('#board').selectAll('circle')
	// boardSVG.selectAll('rect').data(selectedCircles.data().sort(sortBydateAscending)).enter().append('rect').attr('x', 100).attr('y', function(d,i){return i*40+20}).attr('width',).attr('height', 24).
}

function removeCircle(){
	boardSVG_circle.selectAll('circle').remove();
	boardSVG_circle.attr('height', '100%');
	boardSVG.attr('height', '100%');
	timeRectsG.selectAll('rect').remove();
}

function sortByDateAscending(a,b){
	var parseTime = d3.timeParse("%Y-%m")
	return parseTime(a.Start) - parseTime(b.Start)
}

function brushed() {
   
  range = newScale == undefined ? d3.brushSelection(this).map(timeScale.invert)
     		: d3.brushSelection(this).map(newScale.invert);

  console.log(range)
  // slider_handle.attr("transform", "translate(" + timeScale(value) + ",0)");
  timeTextG.select('text').text('Selected time span: '+timeFormat(range[0])+' to '+ timeFormat(range[1]));

  console.log(d3.brushSelection(this));
  storedValue = d3.brushSelection(this);

  console.log(new Date(d3.select('.circleHighlighted').data()[0].End));

  d3.selectAll('.circleHighlighted').filter(function(d)
  	{	return ( range[0] <= new Date(d.Start) && new Date(d.Start) <= range[1] ) ||
  			( range[0] <= new Date(d.End) && new Date(d.End) <= range[1] )
  		})

  .classed('circleFiltered', true).classed('transparent', false).transition().attr('r', 4.5)

  d3.selectAll('.circleHighlighted').filter(function(d)
  	{	return !(( range[0] <= new Date(d.Start) && new Date(d.Start) <= range[1] ) ||
  			( range[0] <= new Date(d.End) && new Date(d.End) <= range[1] ))
  		})

  .classed('circleFiltered', false).classed('transparent', true).transition().attr('r', 3.5);


}

function updated(){

}

function timeZoomed(){

  newScale = d3.event.transform.rescaleX(timeScale)

  // console.log(d3.event.transform.rescaleX(timeScale));
  boardSVG.select('.x.axis').call(timeAxis.scale(newScale))
  

  console.log('zoomed')
  range = storedValue.map(newScale.invert);
  console.log(storedValue);
  timeTextG.select('text').text('Selected time span: '+timeFormat(range[0])+' to '+ timeFormat(range[1]));

  // timeRectsG.attr('transform',`translate($(d3.event.transform.x), 0`);
  console.log(d3.event.transform.x);
  timeRectsG.selectAll('rect').attr('x', function(d){return newScale(parseTime(d.Start))})
  .attr('width', function(d){return newScale(parseTime(d.End)) - newScale(parseTime(d.Start))})

  // brushed();
}
</script>

	
</body>
</html>