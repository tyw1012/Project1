<!DOCTYPE html>
<style type="text/css">
.mapClicked{
	fill: #bbb;
}
.mapNotClicked{
	fill: #aaa; stroke: #eee; stroke-width : 0.2;
}	

</style>


<html>

<head>
	<title></title>
</head>
<body>
<div id = 'main'></div>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
<script type="text/javascript">

var width = 1920, height = 1000;
var margin = {top: 20, bottom: 20, left: 20, right: 20};

var circle_clicked = false;
var map_clicked = false;

var zoom = d3.behavior.zoom()
		   .scaleExtent([1,5])
		   .on("zoom", moveAndZoom);
	
var svg = d3.select('#main').append('svg')
	.attr('width', width)
	.attr('height', height)
	.call(zoom);

var g_map = svg.append('g')
	.attr('width', width)
	.attr('height', height);
	

var projection = d3.geo.mercator()
	.scale(265)
	.center([0, 25])
	.translate([width/2 - 50 , height/2]);
var path = d3.geo.path().projection(projection);




queue()
	.defer(d3.json, "/public/worldmap.geojson")//world map
	.defer(d3.csv, "/public/MIDB_4.01.csv")//base data
	.defer(d3.csv, "/public/MIDA_4.01.csv")//additional data
	.defer(d3.csv, "/public/MIDLOC_1.1.csv")//additional data2
	.await(function(error,mapData, csv_1, csv_2, csv_3){

var data = d3.nest().key(function(d){ return d.DispNum3;})
			 .entries(csv_1)
var data_2 = csv_2, 
	data_3 = csv_3;

console.log(mapData)
// console.log(data);
// console.log(data_2);
// console.log(data_3);

for (var i = 0; i<= data.length-1; i++){

		data[i].countries_A = [];
		data[i].countries_B = [];
		for(var j = 0; j <= data[i].values.length-1; j++){
			// console.log(data[i].values[j].ccode);
			if(data[i].values[j].SideA == 1){
				data[i].countries_A.push(data[i].values[j].ccode);
			}
			else{
				data[i].countries_B.push(data[i].values[j].ccode);	
			}
			

		}

		data[i].DispNum = data_2[i].DispNum3;
		data[i].StYear = data_2[i].StYear;
		data[i].StMon = data_2[i].StMon;
		data[i].EndYear = data_2[i].EndYear;
		data[i].EndMon = data_2[i].EndMon;
		data[i].lat = data_3[i].latitude
		data[i].lon = data_3[i].longitude
		
		delete data[i].key;
		delete data[i].values;
	}

console.log(data);


var features = mapData.features.filter(function(d){return d.properties.COWCODE !== -1});
	
for (var i = 0; i <= features.length-1; i++){
	features[i].clicked = false;
}

	
var map_path = g_map.selectAll('path').data(features).enter().append('path')
		.attr('d', path)
		.attr('vector-effect', 'non-scaling-stroke')
		.classed('mapNotClicked', true)
		.on('mouseover', mouseoverMap)
		.on('mouseout', mouseoutMap)
		.on('click', selectMap)
		
		// .on('click', );

var circles = g_map.selectAll('circle')
			 .data(data)
			 .enter()
			 .append('circle')
			 .attr('cx', (d)=> projection([d.lon,d.lat])[0])
			 .attr('cy', (d)=> projection([d.lon,d.lat])[1])
			 .attr('r', 0)
			 .on('mouseover', mouseoverCircle)
			 .on('mouseout', mouseoutCircle)
			 .on('click', selectCircle)
			 .transition()
			 .delay((d, i) => i*0.2)
			 .duration(1000)
			 .attr('r', 2.5)
			 .transition()
			 .duration(500)
			 .attr('r', 1.2)
			 .style({fill:'purple', strokewidth: 0});
			 



})





function moveAndZoom() {
            var t = d3.event.translate;
            var s = d3.event.scale;

            var x = Math.min(
                (width / height) * (s - 1),
                Math.max(width * (1 - s), t[0]));

            var h = height / 4;
            var y = Math.min(
                h * (s - 1) + h * s,
                Math.max(height * (1 - s) - h * s, t[1]));

            g_map.style("stroke-width", ((1 / s) * 2) + "px");
            g_map.attr('transform', 'translate(' + x + ',' + y + ')scale(' + s + ')');
        }

function mouseoverMap(d){
  // Highlight hovered province
  if (d.clicked == false){
   d3.select(this).style('fill', 'pink');

  }
   console.log(d)
  // Draw effects
}

function mouseoverCircle(d){
  // Highlight hovered province

   d3.select(this).attr('r', 3.5);
  
  // Draw effects
}

function mouseoutMap(d){
	if (d.clicked == false){
		d3.select(this).style('fill', '#aaa' );
	}
  
}

function mouseoutCircle(d){
  d3.select(this).attr('r', 1.2);
}

function selectCircle(d){

	if (circle_clicked === false){

	 highlight(d.countries_A, d.countries_B)
	 console.log("DispNum", d.DispNum)
	 console.log("countriesA", d.countries_A)
	 console.log("countriesB",d.countries_B);

	 circle_clicked = true;
	}

}

function selectMap(d){
	if (circle_clicked){
		g_map.selectAll('path').style({fill:'orange'})
		circle_clicked = false;
	}
		
	else {

		if (!d.clicked){

		d3.select(this).style({fill:'skyblue'});
		g_map.selectAll('circle').filter(
			function (d_){ return include(d_.countries_A, d.properties.COWCODE) ||
								  include(d_.countries_B, d.properties.COWCODE)	})
			.attr('r', 3)
			.style({fill:'green'});
		d.clicked = true;
   		console.log(d)		
		}
		else{
			d.clicked = false
		}
	}
}

function highlight(a,b){
	g_map.selectAll('path').filter(
		function(d){return include(a, d.properties.COWCODE)})
		.style({fill: 'blue'});
	g_map.selectAll('path').filter(
		function(d){return include(b, d.properties.COWCODE)})
		.style({fill: 'red'});

}

function include(arr, obj) {
    for(var i=0; i<=arr.length-1; i++) {
        if (arr[i] == obj) return true;
    }
}

function selected(d){

}

</script>

	
	

	
</body>
</html>