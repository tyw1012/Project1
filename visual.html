<!DOCTYPE html>
<style type="text/css">
*{
	margin:0;
	padding:0;
	list-style:none;

}
.mapClicked{
	/*fill: #b5e3e5;*/
	fill:#d6f2f7;
	/*fill: #c7ebed;*/
	stroke: #a9cbce; stroke-width : 0.5;
}
.mapNotClicked{
	/*background:#eaf4f5;*/
	/*fill: #e6f3f4; */
	/*fill: #f7fcfc;*/
	fill:#fff;
	stroke: #a9cbce; stroke-width : 0.65;  
}	
.circleClicked{
	fill: #dd0202 !important ; stroke: #dd0202 !important; stroke-width : 0.3; 
}

.circleNotClicked{
	fill: #014e66; stroke: #fff; stroke-width : 0.2; 
	opacity: 0.3; 
}
.mapHovered{
	/*fill: #c7ebed;*/
	/*fill:#dcf7f7;*/
	fill:#e5f9f9;

}
.mapHighlighted{
	stroke: #fff; stroke-width : 0;
	box-shadow: -20px -20px 20px black;
}
.circleHighlighted{
	/*fill: #ff6666;*/
	/*fill:#0087a9;*/
	fill:#ff7b4c ;
	/*fill: #bc4b4b;*/
	 stroke: #fff ; stroke-width : 0.3; 
}



.circleDrawn{
	fill: #014e66 ; 
}
.circleDrawn_war{
	fill: #fff !important;
	stroke-width: 4 !important;
}

.circleFiltered{
	/*fill: #f4523d; stroke: #fff; stroke-width : 0.3;*/
	 opacity: 1; 
}
.intersected{
	stroke: #fff; stroke-width : 0.3; 
}
.allied{
	fill: #5b41f4 ;
	stroke: #5b41f4 !important;

}
.hostile{
	fill: #ff6060 ;
	stroke: #ff6060 !important;
}
.war{
	fill:#fff !important; 
	stroke: #014e66 ;
	stroke-width:1.5; 
}
.circleHighlighted_war{
	fill:#fff; 
	stroke:#ff7b4c ;
	stroke-width: 1.5;
}
.circleClicked_war{

	fill:#fff; 
	stroke:#dd0202!important;	
	stroke-width: 1.5;

}
.dispute{
	stroke: #fff!important;
	stroke-width:0.3;
}
.axis .halo {
  stroke: gray;
  stroke-width: 4px;
  stroke-linecap: round;
}

.slider .handle path {
  stroke: white;
  stroke-width: 3px;
  stroke-linecap: round;
  pointer-events: none;
}

.transparent{
	opacity : 0.08;
}
.transparent2{
	opacity : 0.25;
}
.opaque{
	opacity:1;
}
.circleFiltered{
	/*fill: #f4523d; stroke: #fff; stroke-width : 0.3;*/
	 opacity: 1; 
}
.circleWrapper{
	float:left;
	width:60px;
	height: 100%;
}
.timeWrapper{
	float:left;
	width: calc(100% - 60px);
	height:100%;
}
.t_rects{
	fill:#03262d;
}

.borderDiv{
	position: fixed;
	left: 27px; top: 80px;
	height: 50px; width: 200px
}
.legendDiv{

	font-size: 12px;
	font-weight: 600;
	position: absolute;
	left: 15px;
	bottom: 20px;
	height: 50px;
	width: 100%; 
}
.titleDIV{

	position: fixed;
	top: 27px;
	left: 30px;

}
.mainTitle{
	font-weight: lighter;
	font-family: "Times New Roman", Times, serif;
	font-size: 27px;
	opacity: 0.65;
	/*font-style: oblique;*/
	/*font-style: italic;*/

}
.subTitle{
	font-weight: lighter;
	font-family: "Times New Roman", Times, serif;
	font-size: 15px;
	opacity: 0.65;
	line-height: 25px;
}
.track-overlay {
  pointer-events: stroke;
  stroke-width: 50px;
  stroke: transparent;
  cursor: crosshair;
}
.timeText{
	font-weight: italic;
	/*color: #24393d;*/
}


circle.legend_dispute{
	fill:#acc7cf;
}
circle.legend_war{
	stroke-width : 3;

}
circle.legend_high{
	fill:#ff7b4c;
}
circle.legend_high_war{
	stroke:#ff7b4c;
}
circle.legend_allied{
	fill:#5b41f4;
}
circle.legend_allied_war{
	stroke:#5b41f4;

}
circle.legend_hostile{
	fill: #ff6060;
}
circle.legend_hostile_war{
	stroke: #ff6060;

}

</style>


<html style ="height:100%">

<head>
	<title></title>
</head>
<body style ="height: 100%; margin: 0; font-size:11px">
<div id = 'main' style="width:74%; height:100%; float:left; overflow:hidden; background:#f5fbfb; position:relative">
	

</div>

<div id = 'board' style = "width:25.3%; height:100%; float:left; background: #fff; overflow:auto; border-left: 1.5px solid #a9cbce;">
	<div id = 'board_header' style = "width:100%; height:40px"></div>
	<div id = 'board_axis' style = "width:100%; height: 90px"></div>
	<div id = 'board_time' style = "width:100%; height: calc(80% - 130px); overflow:auto; border-bottom: 1px solid #a9cbce;"></div>
	<div id = 'board_info' style = "width:100%; height: 20%;"></div>	

</div>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-zoom.v1.min.js"></script>

<!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
<script src="https://d3js.org/d3-time-format.v2.min.js"></script>
<script type="text/javascript">


var width = 1920; var height = 1000;
// var margin = {top: 20, bottom: 20, left: 20, right: 20};
var timeFormat = d3.timeFormat("%Y %b");
var circle_clicked = false;
var map_clicked = 0;

var dflt_radius = 2.5,
	high_radius = 3.5,
	int_radius = 4,
	war_radius = 2.5;

var parseTime = d3.timeParse("%Y-%m")


var zoom = d3.zoom()
    .scaleExtent([1, 10])
    .on("zoom", zoomed);


// var zoom = d3.behavior.zoom()
// 		   .scaleExtent([1,5])
// 		   .on("zoom", moveAndZoom);
	
var svg = d3.select('#main').append('svg')
	.attr('width', '100%')
	.attr('height', '100%')
	// .attr('fill','blue')
	.call(zoom);
var filter = svg.append('defs').append('filter').attr('id','filter1');

filter.append('feGaussianBlur').attr('result','blurOut').attr('in','SourceAlpha').attr('stdDeviation','0.5');
filter.append('feOffset').attr('dx','0.5').attr('dy','0.5').attr('result','offsetblur');
// filter.append('feBlend').attr('in','SourceGraphic').attr('in2','blurOut').attr('mode','normal');
filter.append('feComponentTransfer').append('feFuncA').attr('type','linear').attr('slope', '0.2');
var feMerge = filter.append('feMerge')
feMerge.append('feMergeNode')
feMerge.append('feMergeNode').attr('in', 'SourceGraphic')

var g_map = svg.append('g')
	// .attr('width', width)
	// .attr('height', height)		
	// .attr('fill', 'blue');

// var g_board = svg.append('g')
//     .attr('width', 500)
//     .attr('height', height);
	
var boardSVG_circle = d3.select('#board_time').append('div').attr('class','circleWrapper').append('svg').attr('height','100%').attr('width','100%').style('overflow','auto').attr('id','boardCircle');
var boardSVG = d3.select('#board_time').append('div').attr('class','timeWrapper').append('svg').attr('height', '100%').attr('width', '100%').style('overflow','auto').attr('id','boardMain');


var bm_width = d3.select('#boardMain').style('width').replace('px','');
var bm_height = d3.select('#boardMain').style('height').replace('px','');

var projection = d3.geoMercator()
	.scale(265)
	.center([0, 35])
	.translate([width/2 -150 , height/2]);
var path = d3.geoPath().projection(projection);

var timeScale = d3.scaleTime()
  .domain([new Date('1946-03'), new Date('1991-12-31')])
  .range([0, bm_width-20])
  // .clamp(true);

var map_timeScale = d3.scaleTime()
  .domain([new Date('1946-03'), new Date('1991-12-31')])
  .range([0, 250])
  .clamp(true);

var timeZoom = d3.zoom().scaleExtent([1, 10]).translateExtent([[-bm_width*0.1, -Infinity], [bm_width*0.93, Infinity]])
      .on('zoom', timeZoomed )

var timeAxis = d3.axisTop(timeScale).ticks(4)
			   .tickFormat(timeFormat).tickSize(5).tickPadding(10)
			   // .tickValues([timeScale.domain()[0], timeScale.domain()[1]]);

var map_timeAxis = d3.axisTop(map_timeScale).ticks(4)
					.tickFormat(timeFormat).tickSize(0).tickValues

var startValue = timeScale(new Date('1946-03'));
startingValue = new Date('1946-03');

var brush = d3.brushX()
	.extent([[0,15],[bm_width-20,bm_height]])
    .on("brush", brushed);

// var sliderSVG = boardSVG.append('svg').attr('class', 'slider').attr('width','100%').attr('height', 80);


var timeTextG = d3.select('#board_axis').append('h2').attr('width',
	'100%').attr('height','100%').classed('timeText',true);
timeTextG.style('font-size', 13).html('　　　　'+'Drag right below to set a time filter.').attr('x',20).attr('y',20);



var boardAxisSVG = d3.select('#board_axis').append('svg').attr('transform','translate(60, 0)').attr('width', '100%').attr('height', 65);

var boardBrushSVG = d3.select('#board_axis').append('svg').attr('transform','translate(60, -2)').attr('width', '100%').attr('height', 712).style('pointer-events', 'none');

var brushableG = boardBrushSVG.append('g').classed('brushable',true).attr('transform','translate(0,-15)').call(brush);

brushableG.select('.selection').attr('fill-opacity', 0.18).attr('height', 690);
brushableG.select('.handle').attr('height',690);
brushableG.select('.overlay').attr('width', bm_width-20).attr('height', 70);
// brushableG.call(brushed);

var zoom_info = boardAxisSVG.append('text').style('opacity', 0.4).style('font-size', 11).text('Zoomable Here').attr('x',bm_width - 95).attr('y',25);


var title = d3.select('#main').append('div').attr('class', 'titleDIV');
title.append('h1').attr('class', 'mainTitle').text('World Militarized Interstate Disputes and Wars ')
title.append('span').attr('class', 'subTitle').attr('y', 60).text('Since after the World War II until the fall of the Soviet Union (1946 - 1991)');

var borderSlider = d3.select('#main').append('div').attr('class', 'borderDiv').append('svg').append('g').classed('slider',true).attr('transform', 'translate(0,30)')

borderSlider.append('line').attr('x1', map_timeScale.range()[0]).attr('x2', map_timeScale.range()[1]).style('stroke-width', "5px").style('stroke', '#ddd')
	.select(function(){return this.parentNode.appendChild(this.cloneNode(true));})
	.attr('style', null)
	.attr('class', 'track-overlay')
	.call(d3.drag()
        .on("start.interrupt", function() { borderSlider.interrupt(); })
        .on("start drag", function(){ dragged(map_timeScale.invert(d3.event.x)); }));

var handle = borderSlider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 8);

var legends = d3.select('#main').append('div').attr('class', 'legendDiv').append('svg').attr('width', '100%')

var axisG = boardAxisSVG.append('g').attr('class', 'x axis').attr('transform','translate(0, 63.5)').call(timeAxis);

var timeZoomBox = boardAxisSVG.append('rect').classed('timezoom',true).attr('y',0).attr('width',bm_width-20).attr('height', 63)
	// .style('fill', '#e4eded')
	.style('opacity', 0)
	.call(timeZoom);



var newScale, map_newScale, features, initial_features,
    range, map_range,
    storedValue = [0, bm_width-20],
    storedSelection1, storedSelection2;

var Drag_info = boardSVG.append('text').style('opacity', 0.4).style('font-size', 11).text('Draggable Here').attr('x',bm_width - 95).attr('y',35);
var timeRectsG = boardSVG.append('g').classed('timeRects',true)

var tooltip = d3.select('body').append('div').attr('class','tooltip').style('opacity', 0);

var data;


queue()
	.defer(d3.json, "./public/worldmap.geojson")//world map
	.defer(d3.csv, "./public/MIDB_4.01.csv")//base data
	.defer(d3.csv, "./public/MIDA_4.01.csv")//additional data
	.defer(d3.csv, "./public/MIDLOC_1.1+war.csv")//additional data2
	.await(function(error,mapData, csv_1, csv_2, csv_3){

data = d3.nest().key(function(d){ return d.DispNum3;})
			 .entries(csv_1)
var data_2 = csv_2, 
	data_3 = csv_3;

console.log(mapData)
// console.log(data);
// console.log(data_2);
// console.log(data_3);

for (var i = 0; i<= data.length-1; i++){

		data[i].countries_A = [];
		data[i].countries_B = [];
		for(var j = 0; j <= data[i].values.length-1; j++){
			// console.log(data[i].values[j].ccode);
			if(data[i].values[j].SideA == 1){
				data[i].countries_A.push(data[i].values[j].ccode);
			}
			else{
				data[i].countries_B.push(data[i].values[j].ccode);	
			}
		}
		data[i].DispNum = data_2[i].DispNum3;
		data[i].StYear = data_2[i].StYear;
		data[i].StMon = data_2[i].StMon;
		data[i].EndYear = data_2[i].EndYear;
		data[i].EndMon = data_2[i].EndMon;
		data[i].lat = data_3[i].latitude
		data[i].lon = data_3[i].longitude;
		data[i].war = data_3[i].war;
		data[i].war_name = data_3[i].war_name;
		data[i].Start = data[i].StYear + '-' + data[i].StMon
		data[i].End = data[i].EndYear + '-' + data[i].EndMon
		// data[i].clicked = false
		// data[i].highlighted = false
		
		delete data[i].key;
		delete data[i].values;
	}

console.log(data);

 initial_features = mapData.features.filter(function(d){return d.properties.COWCODE !== -1 && d.properties.COWSYEAR <= 1991})
 features = mapData.features.filter(function(d){return d.properties.COWCODE !== -1 && d.properties.COWSYEAR <= 1991 && d.properties.COWEYEAR >= 1991});
 
 console.log(features)
	
for (var i = 0; i <= features.length-1; i++){
	features[i].clicked = false;
	features[i].highlighted = false;
}


dragged(new Date('1991-12-31'));

console.log('scale', map_timeScale(new Date('1946-03')))

var circles = g_map.selectAll('circle')
			 .data(data)
			 .enter()
			 .append('circle')			 
			 .attr('cx', (d)=> projection([d.lon,d.lat])[0])
			 .attr('cy', (d)=> projection([d.lon,d.lat])[1])
			 .attr('r', 0)
			 .attr('class', function(d){return d.war==0? 'dispute circleNotClicked' : 'circleNotClicked war opaque'})
			 .on('mouseover', mouseoverCircle)
			 .on('mouseout', mouseoutCircle)
			 .on('click', selectCircle)
			 .transition()
			 .delay((d, i) => i*0.2)
			 .duration(1000)
			 .attr('r', 3.5)
			 .transition()
			 .duration(500)
			 .attr('r', function(d){return d.war==0? dflt_radius : war_radius });
			 // .attr('class', 'circleNotClicked');


boardSVG_circle.attr('height', function(d){return data.length*40.2+7});
boardSVG.attr('height', function(d){return data.length*40.2+70});	

boardSVG_circle.selectAll('circle').data(data.sort(sortByDateAscending))
	.enter().append('circle').attr('class', function(d){return d.war==0?'circleDrawn':'circleDrawn_war'}).attr('cx', 30).attr('cy', function(d,i){return i*40 + 25} ).attr('r',0).style('stroke',function(d){return d3.select(this).classed('circleDrawn')? '#fff' : '#014e66'  })
	.on('mouseover', mouseoverCircle_board)
	.on('mouseout', mouseoutCircle_board)
	.on('click', selectCircle_board)
    .transition()
	// .delay((d, i) => i*5)
	.duration(1000)
	.attr('r', 12);;

timeRectsG.selectAll('rect')
		.data(data.sort(sortByDateAscending))
		.enter()
		.append('rect')
		.attr('x', function(d){return newScale==undefined ? timeScale(parseTime(d.Start)) : newScale(parseTime(d.Start))})
		// .attr('y', )
		.attr('width', 0)
		.attr('y', function(d,i){return i*40 + 12.5})
		.attr('class', 't_rects')
		.transition()
		.duration(700)
		// .attr('fill','#014e66')
		.attr('width',
			 function(d){return newScale == undefined? d3.max([timeScale(parseTime(d.End)) - timeScale(parseTime(d.Start)),1]) : d3.max([newScale(parseTime(d.End)) - newScale(parseTime(d.Start)),1])})
		
		.attr('height', 24)

brushableG.select('.selection').style('height', 685);
brushableG.select('.handle').style('height', 685);


drawLegends();
})



function mouseoverMap(d){
  // Highlight hovered province
  if (!d3.select(this).classed('mapClicked') && !d3.select(this).classed('mapHighlighted') ){
   d3.select(this).classed('mapHovered', true );

  }
    console.log(d)
  // Draw effects
}

function mouseoutMap(d){
	if (!d3.select(this).classed('mapClicked') && !d3.select(this).classed('mapHighlighted')){
	d3.select(this).classed('mapHovered', false ).classed('mapNotClicked',true);
	}
  
}

function mouseoverCircle(d){

	if (map_clicked == 0){

	 d3.select(this).attr('r', dflt_radius + 1 );	

	}

	else if(map_clicked == 1){

		if(d3.select(this).classed('circleHighlighted')||d3.select(this).classed('circleHighlighted_war')){
			d3.select(this).attr('r', high_radius + 1);
		}
	}
	else {

		if(d3.select(this).classed('intersected')){
			d3.select(this).attr('r', int_radius + 1 );
		}
	}

  

}


function mouseoutCircle(d){

	if (!d3.select(this).classed('circleClicked')){


		if (map_clicked == 0){

		 d3.select(this).attr('r', dflt_radius  );	

		}

		else if(map_clicked == 1){

			if(d3.select(this).classed('circleHighlighted')||d3.select(this).classed('circleHighlighted_war')){
				d3.select(this).attr('r', high_radius );
			}
		}
		else {

			if(d3.select(this).classed('intersected')){
				d3.select(this).attr('r', int_radius  );
			}
		}

	
 } 
}


function mouseoverCircle_board(d){

   d3.select(this).attr('r', 14 );

   if(!circle_clicked){
	   if (map_clicked == 0){
	   	g_map.selectAll('.dispute,.war').filter(function(d_){return d_.DispNum == d.DispNum })
	   	.transition().duration(150)
	   	.attr('r', dflt_radius + 2);
	   }

	   else if (map_clicked == 1){
	   	 g_map.selectAll('.circleHighlighted,.circleHighlighted_war').filter(function(d_){return d_.DispNum == d.DispNum })
	   	.transition().duration(150)
	   	.attr('r', high_radius + 2);
	   }
	   else{
	   	g_map.selectAll('.intersected').filter(function(d_){return d_.DispNum == d.DispNum })
	   	.transition().duration(150)
	   	.attr('r',int_radius + 2);
	   }
	}
}

function mouseoutCircle_board(d){

	d3.select(this).attr('r', 12);

	if(!circle_clicked){
		 if (map_clicked == 0){
	   	g_map.selectAll('.dispute,.war').filter(function(d_){return d_.DispNum == d.DispNum })
	   	.transition().duration(150)
	   	.attr('r', dflt_radius);
	     }
	     else if (map_clicked == 1){
	   	 g_map.selectAll('.circleHighlighted,.circleHighlighted_war').filter(function(d_){return d_.DispNum == d.DispNum })
	   	.transition().duration(150)
	   	.attr('r',high_radius);
	    }
	    else{
	   	g_map.selectAll('.intersected').filter(function(d_){return d_.DispNum == d.DispNum })
	   	.transition().duration(150)
	   	.attr('r', int_radius);
	    }
	}
}

function selectCircle(d){

	 
	 var scrollHeight = boardSVG_circle.selectAll('circle')
	 					.filter(function(d_){return d_.DispNum == d.DispNum }).property('cy').animVal.value - bm_height/2
	 

	if (!circle_clicked ){
	 g_map.selectAll('path.map').attr('class', null).classed('map mapNotClicked',true);
	 highlight(d.countries_A, d.countries_B, d);
	 // drawPath(d.countries_A, d.countries_B);
	 console.log("DispNum", d.DispNum)
	 console.log("countriesA", d.countries_A)
	 console.log("countriesB",d.countries_B);

	 // g_map.selectAll('.dispute,.war').attr('style',null).attr('class', function(d){return d.war==0? 'dispute circleNotClicked':'war circleNotClicked opaque' }).attr('r', dflt_radius);

	 // g_map.selectAll('.circleHighlighted,.circleHighlighted_war,.intersected').classed('transparent2', true).classed('opaque',false)

	 d3.select(this).classed('dispute')?
	 	 d3.select(this).classed('circleNotClicked', false)
	 	 .classed('circleClicked', true):
	 	 d3.select(this).classed('circleNotClicked', false)
	 	 .classed('circleClicked_war', true)

	 // .classed('opaque', true)
	 // .classed('transparent2', false)

	 

	 twinkle(d3.select(this));

	 
	 d3.select('#board_time').transition().duration(1500).tween('scroll', scrollTopTween(scrollHeight));

	 boardSVG_circle.selectAll('circle').filter(function(d_){return d_.DispNum == d.DispNum}).classed('circleClicked',true).call(twinkle_big)

	 console.log('this', this);
	 circle_clicked = true;
	}
	else{
		if ( d3.select(this).classed('circleClicked')||d3.select(this).classed('circleClicked_war') ){
			g_map.selectAll('path.map').attr('style', null).classed('map mapNotClicked', true).classed('mapHighlighted', false);


			g_map.selectAll('.circleClicked,.circleClicked_war').transition().attr('r', dflt_radius);
			// g_map.selectAll('circle.dispute').attr('style',null).attr('class',null).classed('dispute circleNotClicked', true).attr('r', dflt_radius);

			

			circle_clicked = false;
			map_clicked = 0;
			initialize();
		}
		else{

			 d3.select('#board_time').transition().duration(1500).tween('scroll', scrollTopTween(scrollHeight));

			g_map.selectAll('path.map').attr('class', null).attr('style', null).classed('map mapNotClicked',true);
			 highlight(d.countries_A, d.countries_B, d);

			// g_map.selectAll('.circleHighlighted,.circleHighlighted_war,.intersected').classed('transparent2', true).classed('opaque',false)

			g_map.selectAll('.circleClicked,.circleClicked_war')
			.classed('circleClicked',false).classed('circleClicked_war',false)
			.transition().attr('r', function(d){return map_clicked ==0? dflt_radius: map_clicked ==1? high_radius:  int_radius})

			 d3.select(this).classed('dispute')?
		 	 d3.select(this).classed('circleNotClicked', false)
		 	 .classed('circleClicked', true):
		 	 d3.select(this).classed('circleNotClicked', false)
		 	 .classed('circleClicked_war', true)
			

			 twinkle(d3.select(this));
			 boardSVG_circle.selectAll('.circleClicked').classed('circleClicked', false).transition().attr('r',12);
			 boardSVG_circle.selectAll('circle').filter(function(d_){return d_.DispNum == d.DispNum}).classed('circleClicked',true).call(twinkle_big)
			 

		}

	}

}

function selectCircle_board(d){


	if (!circle_clicked ){
	 g_map.selectAll('path.map').attr('class', null).classed('map mapNotClicked',true);
	 highlight(d.countries_A, d.countries_B, d);
	 // drawPath(d.countries_A, d.countries_B);
	 console.log("DispNum", d.DispNum)
	 console.log("countriesA", d.countries_A)
	 console.log("countriesB",d.countries_B);

	  g_map.selectAll('.dispute,.war').attr('style',null).attr('class', function(d){return d.war==0? 'dispute circleNotClicked':'war circleNotClicked opaque' }).attr('r', dflt_radius);

	 d3.select(this).attr('class',function(d){return d3.select(this).classed('circleDrawn_war')? 'circleDrawn_war circleClicked_war': 'circleDrawn circleClicked'});

	 twinkle_big(d3.select(this));

	 g_map.selectAll('.dispute,.war').filter(function(d_){return d_.DispNum == d.DispNum }).attr('style',null).attr('class', function(d){return d.war==0? 'dispute circleClicked':'war circleClicked_war' });

	 twinkle(d3.select('.dispute.circleClicked,.war.circleClicked_war'));
	 circle_clicked = true;
	}
	else{
		if(!d3.select(this).classed('circleClicked')){

			g_map.selectAll('path.map').attr('class', null).attr('style',null).classed('map mapNotClicked',true);
			highlight(d.countries_A, d.countries_B, d);

			 g_map.selectAll('.dispute,.war').attr('style',null).attr('class', function(d){return d.war==0? 'dispute circleNotClicked':'war circleNotClicked opaque' }).transition().attr('r', dflt_radius);


			boardSVG_circle.selectAll('.circleClicked,.circleClicked_war').classed('circleClicked',false).classed('circleClicked_war',false).transition().attr('r', 12)
			// .style('fill', function(d){return map_clicked == 0? '#014e66' : map_clicked == 1? '#ff7b4c' : d.allied == true? '#5b41f4' : '#ff6060'});

			d3.select(this).attr('class',function(d){return d3.select(this).classed('circleDrawn_war')? 'circleDrawn_war circleClicked_war': 'circleDrawn circleClicked'});
	 		twinkle_big(d3.select(this));

	 		g_map.selectAll('.dispute,.war').filter(function(d_){return d_.DispNum == d.DispNum }).attr('style',null).attr('class', function(d){return d.war==0? 'dispute circleClicked':'war circleClicked_war' });

	 		twinkle(d3.select('.dispute.circleClicked,.war.circleClicked_war'));

		}
		else{

			g_map.selectAll('path.mapHighlighted').attr('style', null).classed('map mapNotClicked', true).classed('mapHighlighted', false);

			// d3.selectAll('.dispute.circleClicked').classed('circleClicked',false).classed('circleNotClicked',true).transition().attr('r',dflt_radius)


			boardSVG_circle.select('.circleClicked').classed('circleClicked',false).classed('circleDrawn',true).transition().attr('r',dflt_radius)

			initialize();
			circle_clicked = false;
			map_clicked = 0;

		}	
	

	}
	

}

function scrollTopTween(scrollTop) { 
    return function() { 
        var i = d3.interpolateNumber(document.getElementById('board_time').scrollTop, scrollTop); 
        console.log(this.scrollTop);
        return function(t) { document.getElementById('board_time').scrollTop = i(t);
        	// console.log('this2', this)
        	// console.log(this.scrollTop)
        }
        	; 
    }; 
} 

function twinkle(circle){
	circle.transition().duration(800).ease(d3.easeSinOut).attr('r', 6).transition().duration(800).ease(d3.easeSinIn).attr('r', 4).on('end', function(){ d3.select(this).call(twinkle); });
}

function twinkle_big(circle){
	circle.transition().duration(800).ease(d3.easeSinOut).attr('r', 16).transition().duration(800).ease(d3.easeSinIn).attr('r', 11).on('end', function(){ d3.select(this).call(twinkle_big); });
}


function selectMap(d){

var fltr_circles = g_map.selectAll('.dispute,.war').filter(function (d_){
	return include(d_.countries_A, d.properties.COWCODE) ||
	  	   include(d_.countries_B, d.properties.COWCODE)});

var allCircles, allRects;
	
			if (circle_clicked ){
				
				g_map.selectAll('path.map').attr('style', null).classed('mapNotClicked', true).
				classed('mapClicked', false).classed('mapHighlighted', false);

				g_map.select('.circleClicked').transition().attr('r', dflt_radius)

				
				
				d.clicked = false;
				
				boardSVG_circle.select('.circleClicked').transition().attr('r', 12);
				initialize();
				map_clicked = 0;
				circle_clicked = false;

			}
				
			else { 

				if (map_clicked == 0){
						
					 	storedSelection1 = d3.select(this).data()[0].properties
					 	// console.log('storedSelection', storedSelection1)
						g_map.selectAll('.dispute.circleNotClicked,.war.circleNotClicked').classed('transparent',true).classed('opaque', false).classed('circleFiltered',false).attr('r', dflt_radius);
						d3.select(this).attr('style', null).attr('class', null).classed('map mapClicked', true);
					
						
						fltr_circles.attr('style',null)
						.attr('class', function(){return d3.select(this).classed('war')? 'war circleHighlighted_war' : 'dispute circleHighlighted'})
						.classed('opaque', true).classed('transparent',false)
						.transition().attr('r',3.5);
						// d3.selectAll('.circleNotClicked').classed('transparent2',true);
						console.log("fltr",fltr_circles);
						d.clicked = true;
						map_clicked = 1
						// console.log(d)
						drawCircle();
						// brush.extent()

							//Legend drawing
						if (document.querySelector('.circleHighlighted') !== null) {

	   						legends.select('circle.legend_dispute').classed('legend_high',true)
	   						// .attr('r', 7).attr('cx', 200).attr('cy', 30);
							legends.select('text.legend_dispute').classed('legend_high', true).text(' Dispute Where '+d.properties.CNTRY_NAME+' got Involved')
							// .attr('x',215).attr('y',34);
						}
						else{
							legends.selectAll('.legend_dispute').remove();
						}

						if(document.querySelector('.circleHighlighted_war') !== null){


							var scrollWidth = legends.select('text.legend_dispute').property('textContent').length*6.5 + 25


							legends.select('circle.legend_war').classed('legend_high_war',true).attr('r', 7).attr('cx', scrollWidth +25 ).attr('cy', 30);
							legends.select('text.legend_war').classed('legend_high_war', true).text(' War Where '+d.properties.CNTRY_NAME+' got Involved').attr('x',scrollWidth +40).attr('y',34);
						}
						else{
							legends.selectAll('.legend_war').remove();
						}

					

	
				}

				else{

					if(map_clicked == 1){

						if(!d3.select(this).classed('mapClicked'))
						{
							storedSelection2 = d3.select(this).data()[0].properties.COWCODE

							d3.select(this).attr('style', null).attr('class', null).classed('map mapClicked', true);
							d.clicked = true;
							var fltr_circles_int = fltr_circles
								.filter(function()
									{return d3.select(this).classed('circleHighlighted')||d3.select(this).classed('circleHighlighted_war')}
									)
								.attr('class', function(d){return d.war ==0?'dispute intersected' : 'war intersected'})

							var fltr_circles_int_allied = fltr_circles_int.filter( function(d_){
								return (include(d_.countries_A, d.properties.COWCODE) && include(d_.countries_A, storedSelection1.COWCODE)) ||
									   (include(d_.countries_B, d.properties.COWCODE) && include(d_.countries_B, storedSelection1.COWCODE))
									}).classed('allied', true);

							// fltr_circles_int_allied.style('fill', function(d){return d.war==0? '#5b41f4' : '#fff'});
							// fltr_circles_int_allied.style('stroke', function(d){
							// 	return d.war==0? '#fff': '#5b41f4'
							// })

							var fltr_circles_int_hostile = fltr_circles_int.filter( function(d_){
								return !(
									   (include(d_.countries_A, d.properties.COWCODE) && include(d_.countries_A, storedSelection1.COWCODE)) ||
									   (include(d_.countries_B, d.properties.COWCODE) && include(d_.countries_B, storedSelection1.COWCODE))
									   )
									}).classed('hostile', true);

							// fltr_circles_int_hostile.style('fill', function(d){return d.war==0? '#ff6060' : '#fff'});
							// fltr_circles_int_hostile.style('stroke', function(d){
							// 	return d.war==0? '#fff': '#ff6060'
							// })

							fltr_circles_int.transition().attr('r',2).transition().attr('r',4);


							d3.selectAll('.circleHighlighted,.circleHighlighted_war').attr('style',null).attr('class', function(d){return d.war==0? 'dispute circleNotClicked transparent':'war circleNotClicked transparent' }).attr('r',dflt_radius);	
							// fltr_circles[0].filter(function(d){return d3.select(this).classed('circleHighlighted') }).attr('class',null).attr('style',null).classed('circleNotClicked', true);
							map_clicked = 2;
							drawCircle();

							legends.selectAll('.legend_dispute,.legend_war').remove();
							
							var legendLength = 20;

							if (document.querySelector('.dispute.intersected.hostile') !== null) {

								var d_hostile = legends.append('circle').attr('r', 7).attr('cx', legendLength).attr('cy', 30).classed('legend_dispute dispute legend_hostile', true);
								var d_hostile_text = legends.append('text').classed('legend_dispute legend_hostile', true).text('Dispute where '+d.properties.CNTRY_NAME+' and '+storedSelection1.CNTRY_NAME+' were hostile').attr('x',legendLength + 15).attr('y',34);
							
								
								legendLength = legendLength + d_hostile_text.property('textContent').length*6.5 + 25
							}

							if (document.querySelector('.dispute.intersected.allied') !== null){

								var d_allied = legends.append('circle').attr('r', 7).attr('cx', legendLength).attr('cy', 30).classed('legend_dispute dispute legend_allied', true);
								var d_allied_text = legends.append('text').classed('legend_dispute legend_allied', true).text('Dispute where '+d.properties.CNTRY_NAME+' and '+storedSelection1.CNTRY_NAME+' were allied').attr('x',legendLength + 15).attr('y',34);

								legendLength = legendLength + d_allied_text.property('textContent').length*6.5 + 25


							}

							if (document.querySelector('.war.intersected.hostile') !== null) {

								var w_hostile = legends.append('circle').attr('r', 7).attr('cx', legendLength).attr('cy', 30).classed('legend_war war legend_hostile_war', true);
								var w_hostile_text = legends.append('text').classed('legend_war legend_hostile_war', true).text('War where '+d.properties.CNTRY_NAME+' and '+storedSelection1.CNTRY_NAME+' were hostile').attr('x',legendLength + 15).attr('y',34);

								legendLength = legendLength + w_hostile_text.property('textContent').length*6.5 + 25

							}

							if (document.querySelector('.war.intersected.allied') !== null) {

								var w_allied = legends.append('circle').attr('r', 7).attr('cx', legendLength).attr('cy', 30).classed('legend_war war legend_allied_war', true);
								var w_allied_text = legends.append('text').classed('legend_war legend_allied_war', true).text('War where '+d.properties.CNTRY_NAME+' and '+storedSelection1.CNTRY_NAME+' were allied').attr('x',legendLength + 15).attr('y',34);

								legendLength = legendLength + w_hostile_text.property('textContent').length*6.5 + 25

							}



						}

						else{

							d.clicked = false
							d3.select(this).attr('style', null).classed('mapNotClicked', true).classed('mapClicked',false);

						
							
							map_clicked = 0;

							drawLegends();
							initialize();

							// legends.select('circle.legend_dispute').attr('class', 'legend_dispute dispute')
							// legends.select('text.legend_dispute').attr('class', 'legend_dispute').text('Dispute');

							// scrollWidth = legends.select('text.legend_dispute').property('scrollWidth')

							// legends.select('circle.legend_war').attr('class','legend_war war').attr('cx', scrollWidth + 15);
							// legends.select('text.legend_war').attr('class', 'legend_war').text('War').attr('x', scrollWidth + 30);
							

						
						}
					}
				    else{

				    	g_map.selectAll('path.map').attr('style', null).classed('mapNotClicked', true).classed('mapClicked', false).classed('mapHighlighted', false);
						drawLegends();
						initialize();

						legends.selectAll('.legend_hostile').remove();
						legends.selectAll('.legend_allied').remove();
											
						circle_clicked = false;
						d.clicked = false;
						map_clicked = 0;


				    }		
				}		
			}
	}


function highlight(a,b,circle_data){

	var a_path = g_map.selectAll('path.mapNotClicked').filter(
		function(d){ return include(a, d.properties.COWCODE)}).classed('mapHighlighted', true)
		a_path.transition()
		// .style('fill','#93d1f9')
		.style('fill','#0cafcc')
		// .style('fill', '#c3e6f4')
		.attr('filter','url(#filter1)');
	
	var b_path = g_map.selectAll('path.mapNotClicked').filter(
		function(d){ return include(b, d.properties.COWCODE)}).classed('mapHighlighted', true)
		b_path.transition()
		// .style('fill', '#ffb760')
		.style('fill','#f7c062')
		// .style('fill', '#f9eac2')
		.attr('filter','url(#filter1)');

	// 	console.log(a_path.data())
	// var a_centroid = [],
	// 	b_centroid = [],
	// 	line_data_a = [],
	// 	line_data_b = [],
	// 	a_path, b_path;

	// var circle_coord = projection([circle_data.lon, circle_data.lat]);

	// console.log("cent", path.centroid(a_path.data()[0]));

	// for (var i = 0; i <= a_path.data().length-1; i++ ){
	// 	a_centroid.push(path.centroid(a_path.data()[i]));

	// 	line_data_a.push(
	// 		[{'x': a_centroid[i][0],
	// 		  'y': a_centroid[i][1]}
	// 		   ,
	// 		 {'x': circle_coord[0]*0.8,
	// 		  'y': }  
	// 		 {'x': circle_coord[0],
	// 		  'y': circle_coord[1]}]
	// 					  )
	// }	
	
	// for (var i = 0; i <= b_path.data().length-1; i++ ){
	// 	b_centroid.push(path.centroid(b_path.data()[i]));

	// 	line_data_b.push(
	// 		[{'x': b_centroid[i][0],
	// 		  'y': b_centroid[i][1]}
	// 		   ,
	// 		 {'x': circle_coord[0],
	// 		  'y': circle_coord[1]}]
	// 					  )
	// }


	// console.log(line_data_a)
	// console.log(circle_coord)

	// var line = d3.line()
	// 		  .x(function(d){return d.x;})
	// 		  .y(function(d){return d.y;})
	// 		  .curve(d3.curveCardinal)
			  

 //    for (var i = 0; i <= line_data_a.length-1; i++ ){

 //    a_path = g_map.append('path');

 //    a_path.attr('d', line(line_data_a[i])).style('visibility', 'invisible');
 //    		 // .attr('stroke','blue')
 //    		 // .attr('stroke-width', 0.5)

 //    var circle_a = g_map.append('circle').attr('r', 2).attr('fill','#55a8ed').attr('transform', 'translate(' + a_centroid[i] + ')');

 //    circle_a.transition().duration(1300).attrTween('transform', translateAlong(a_path.node())).style('fill-opacity',0.7).transition().duration(500).style('fill-opacity',0)		

 //    // circle_a.transition().style('fill-opacity', 0.1); 

 //    }

 //    for (var i = 0; i <= line_data_b.length-1; i++ ){

 //    b_path = g_map.append('path');

 //    b_path.style('stroke-dasharray', '1,2').attr('d', line(line_data_b[i]))
 //    		 // .attr('stroke-width', 0.5)
 //   	g_map.append('path').style('stroke','red').style('stroke-width', 0.5).attr('d', line(line_data_b[i])).transition().duration(1000).attrTween('stroke-dasharray', tweenDash);

 //   	// g_map.append('path').style('stroke','red').style('stroke-dasharray', 2,2).attrTween('d', tweenDash2);

 //    // var circle_b = g_map.append('circle').attr('r', 2).attr('fill','#ef5169').attr('transform', 'translate(' + b_centroid[i] + ')');

 //    // circle_b.transition().duration(1300).attrTween('transform', translateAlong(b_path.node())).style('fill-opacity',0.7).transition().duration(500).style('fill-opacity',0)
 //    // circle_b.transition().style('fill-opacity', 0.1); 

 //    }
    

}


function include(arr, obj) {
    for(var i=0; i<=arr.length-1; i++) {
        if (arr[i] == obj) return true;
    }
}

function zoomed() {
  g_map.attr('transform',d3.event.transform);
}


function drawCircle(){

	var selectedCircles, selectedCircles_merged, selectedCircles_allied, selectedCircles_hostile, data_intersected;
	var newBind_circle;
	var newBind_rect;

	if (map_clicked == 1){

		selectedCircles = d3.selectAll('.circleHighlighted,.circleHighlighted_war')
		var data_highlighted = selectedCircles.data().sort(sortByDateAscending);

		boardSVG_circle.attr('height', function(d){return selectedCircles.data().length*40.2+45});
		boardSVG.attr('height', function(d){return selectedCircles.data().length*40.2+45});
		d3.select('.timezoom').attr('height', function(d){return selectedCircles.data().length*40.2+45} )
	

		newBind_circle = boardSVG_circle.selectAll('circle').data(data_highlighted, function(d){
			return d.DispNum})
		newBind_circle.exit().transition().attr('r', 0).remove();
		newBind_circle.attr('class',function(d){return d.war == 0? 'circleDrawn' : 'circleDrawn_war'}).transition().duration(1000).attr('cy', function(d,i){return i*40 + 25} );

		boardSVG_circle.selectAll('.circleDrawn').style('fill','#ff7b4c')
		boardSVG_circle.selectAll('.circleDrawn_war').style('stroke', '#ff7b4c');

		newBind_rect = timeRectsG.selectAll('rect').data(data_highlighted, function(d){ return d.DispNum}).attr('class', 't_rects')
		newBind_rect.exit().transition().attr('width', 0).remove();
		newBind_rect.transition().duration(1000).attr('y', function(d,i){
			return i*40 + 12.5})
		
		}

	else{

		selectedCircles = d3.selectAll('.intersected')
		selectedCircles_allied = d3.selectAll('.allied')
		selectedCircles_hostile = d3.selectAll('.hostile')
		 selectedCircles_merged = selectedCircles_hostile.data();

		
		for (var i = 0; i<=selectedCircles_hostile.data().length-1; i++){
			selectedCircles_hostile.data()[i].allied = false;
		}

		for (var i = 0; i<=selectedCircles_allied.data().length-1; i++){
			selectedCircles_allied.data()[i].allied = true;
			selectedCircles_merged.push(selectedCircles_allied.data()[i]);
		}


		data_intersected = selectedCircles_merged.sort(sortByDateAscending);

		console.log(data_intersected);

		boardSVG_circle.attr('height', function(d){return data_intersected.length*40.2+45});
		boardSVG.attr('height', function(d){return data_intersected.length*40.2+45});	
		d3.select('.timezoom').attr('height', function(d){return data_intersected.length*40.2+45} )

		newBind_circle = boardSVG_circle.selectAll('circle').data(data_intersected, function(d){return d.DispNum});

		newBind_circle.exit().transition().attr('r', 0).remove();
		newBind_circle.attr('class',function(d){return d.war == 0? 'circleDrawn' : 'circleDrawn_war'}).transition().duration(1000).attr('cy', function(d,i){ return i*40 + 25})
		.style('fill', function(d){
			return d.allied == false && d.war == 0? '#ff6060' 
			: 	   d.allied == false && d.war == 1? '#fff' 
			:      d.allied == true  && d.war == 0? '#5b41f4'
			:      									'#fff'} )
		.style('stroke', function(d){
			return d.allied == false && d.war == 0? '#fff' 
			: 	   d.allied == false && d.war == 1? '#ff6060' 
			:      d.allied == true  && d.war == 0? 'fff'
			:      									'#5b41f4'} );

		newBind_rect = timeRectsG.selectAll('rect').data(data_intersected, function (d){return d.DispNum}).attr('class', 't_rects');

		newBind_rect.exit().transition().attr('width', 0).remove();
		newBind_rect.transition().duration(1000).attr('y',function(d,i){
			return i*40 + 12.5})
		}

	// console.log(selectedCircles.data().sort(sortByDateAscending));

	// brushableG.select('.selection').style('height', selectedCircles.data().length*40.2+7 );
	// brushableG.select('.handle').style('height', selectedCircles.data().length*40.2+7 );

	// brush.extent([[0,15],[bm_width-30, selectedCircles.data().length*40.2+7]]);
	// brushableG.call(brush);

	d3.select('.overlay').attr('width', bm_width-20).attr('height', 70);


	
	// brushableG.call(brush.event)
	// var displayedCircles = d3.select('#board').selectAll('circle')
	// boardSVG.selectAll('rect').data(selectedCircles.data().sort(sortBydateAscending)).enter().append('rect').attr('x', 100).attr('y', function(d,i){return i*40+20}).attr('width',).attr('height', 24).
}

function removeCircle(){
	boardSVG_circle.selectAll('circle').remove();
	boardSVG_circle.attr('height', '100%');
	boardSVG.attr('height', '100%');
	timeRectsG.selectAll('rect').remove();
}

function sortByDateAscending(a,b){
	var parseTime = d3.timeParse("%Y-%m")
	return parseTime(a.Start) - parseTime(b.Start)
}

function brushed() {
  
	if(circle_clicked){

		g_map.selectAll('path.mapHighlighted').attr('style', null).classed('map mapNotClicked', true).classed('mapHighlighted', false);
		g_map.select('.circleClicked').transition().attr('r', dflt_radius);
		g_map.selectAll('circle.dispute').attr('style',null).attr('class',null).classed('dispute circleNotClicked', true).attr('r', dflt_radius);
		circle_clicked = false;

	}

   range = newScale == undefined ?  d3.brushSelection(this).map(timeScale.invert)
     		: d3.brushSelection(this).map(newScale.invert);

  console.log(range)
 
 // timeFormat()	
  timeTextG.select('text').html('Selected time span: '+timeFormat(range[0])+' to '+ timeFormat(range[1]));

  console.log(d3.brushSelection(this));
  storedValue = d3.brushSelection(this);
  dragged(range[1]);

  if (map_clicked == 0){

  	g_map.selectAll('.dispute,.war').filter(function(d){
  		return ( range[0] <= new Date(d.Start) && new Date(d.Start) <= range[1] ) ||
  			( range[0] <= new Date(d.End) && new Date(d.End) <= range[1] ) || ( new Date(d.Start) <= range[0] && range[1] <= new Date(d.End))
  	})
  	.style('opacity',null).classed('circleFiltered', true).classed('transparent', false).transition().attr('r', dflt_radius+1)


 	g_map.selectAll('.dispute,.war').filter(function(d){
  		return !(( range[0] <= new Date(d.Start) && new Date(d.Start) <= range[1]) ||
  			( range[0] <= new Date(d.End) && new Date(d.End) <= range[1] ) || ( new Date(d.Start) <= range[0] && range[1] <= new Date(d.End)) )
  	})
  	.classed('circleFiltered', false).classed('transparent', true).style('opacity', 0.05).transition().attr('r', dflt_radius)

  }

  else if (map_clicked == 1){

  	g_map.selectAll('path.map').filter(function(d){return d.properties.COWCODE == storedSelection1.COWCODE}).attr('class', 'map mapClicked');

  

  	console.log('stored1',storedSelection1);

  	d3.selectAll('.circleHighlighted,.circleHighlighted_war').filter(function(d)
  	{	return ( range[0] <= new Date(d.Start) && new Date(d.Start) <= range[1] ) ||
  			( range[0] <= new Date(d.End) && new Date(d.End) <= range[1] ) || ( new Date(d.Start) <= range[0] && range[1] <= new Date(d.End))
  		})

  .classed('circleFiltered', true).classed('transparent', false).transition().attr('r', high_radius+1)

  d3.selectAll('.circleHighlighted,.circleHighlighted_war').filter(function(d)
  	{	return !(( range[0] <= new Date(d.Start) && new Date(d.Start) <= range[1] ) ||
  			( range[0] <= new Date(d.End) && new Date(d.End) <= range[1] ) || ( new Date(d.Start) <= range[0] && range[1] <= new Date(d.End)) )
  		})

  .classed('circleFiltered', false).classed('transparent', true).classed('opaque',false).transition().attr('r', high_radius);

  }

  else {

 //  	storedSelection1.attr('class', 'mapClicked');
 //  	storedSelection2.attr('class', 'mapClicked');
	// console.log('stored1',storedSelection2);

	g_map.selectAll('path.map').filter(function(d){return d.properties.COWCODE == storedSelection1.COWCODE || d.properties.COWCODE == storedSelection2}).attr('class', 'map mapClicked');
	


  	d3.selectAll('.intersected').filter(function(d)
  	{	return ( range[0] <= new Date(d.Start) && new Date(d.Start) <= range[1] ) ||
  			( range[0] <= new Date(d.End) && new Date(d.End) <= range[1] ) || ( new Date(d.Start) <= range[0] && range[1] <= new Date(d.End))
  		})

  .classed('circleFiltered', true).classed('transparent', false).transition().attr('r', int_radius+1)

  d3.selectAll('.intersected').filter(function(d)
  	{	return !(( range[0] <= new Date(d.Start) && new Date(d.Start) <= range[1] ) ||
  			( range[0] <= new Date(d.End) && new Date(d.End) <= range[1] ) || ( new Date(d.Start) <= range[0] && range[1] <= new Date(d.End)) )
  		})

  .classed('circleFiltered', false).classed('transparent', true).transition().attr('r', int_radius);

  }

  
  // handle.attr('cx', map_timeScale(range[1]))
}

function dragged(h){
	console.log('dragged')
	handle.attr('cx', map_timeScale(h))

	var now = h;

	console.log(now);

	// console.log('features', initial_features)
	var new_features = initial_features.filter(function(d){return new Date(d.properties.COWSYEAR + '-' + d.properties.COWSMONTH) <= now && new Date(d.properties.COWEYEAR + '-' + d.properties.COWEMONTH) >= now })

	console.log('new', new_features)

	var newBind_path = g_map.selectAll('path.map').data(new_features)

	newBind_path.exit().remove();

	newBind_path.enter().insert('path', '.circleNotClicked').merge(newBind_path)
	.attr('d', path)
	.attr('vector-effect', 'non-scaling-stroke')
	.attr('class',null)
	.classed('map mapNotClicked', true)
	.on('mouseover', mouseoverMap)
	.on('mouseout', mouseoutMap)
	.on('click', selectMap)

	
}

function timeZoomed(){

  newScale = d3.event.transform.rescaleX(timeScale)

  // console.log(d3.event.transform.rescaleX(timeScale));
  boardAxisSVG.select('.x.axis').call(timeAxis.scale(newScale))


  console.log('zoomed')
  range = storedValue.map(newScale.invert);
  console.log(storedValue);
  timeTextG.select('text').text('Selected time span: '+timeFormat(range[0])+' to '+ timeFormat(range[1]));

  // timeRectsG.attr('transform',`translate($(d3.event.transform.x), 0`);
  console.log(d3.event.transform.x);
  timeRectsG.selectAll('rect').attr('x', function(d){return newScale(parseTime(d.Start))})
  .attr('width', function(d){return d3.max([newScale(parseTime(d.End)) - newScale(parseTime(d.Start)),1])})

  // brushed();
}

function translateAlong(path) {
  var l = path.getTotalLength();
  console.log('l',l)
  return function(d, i, a) {
    return function(t) {
      var p = path.getPointAtLength(t * l);
      return "translate(" + p.x + "," + p.y + ")";
    };
  };
}

// function tweenDash() {
//   var l = this.getTotalLength(),
//       i = d3.interpolateString("0," + l, l + "," + l);
//   return function(t) { return i(t); };
// }

// function tweenDash2() {
// 	var d = this.attr('d')
// }

// function transitionA(path) {
//   path.transition()
//       .duration(7500)
//       .attrTween("stroke-dasharray", tweenDash)
//       .each("end", function() { d3.select(this).call(transitionA); });
// }

function initialize(){


	g_map.selectAll('.dispute,.war')
	.attr('r', function(){return d3.select(this).classed('war')? war_radius : dflt_radius})
	.attr('class',function(){return d3.select(this).classed('war')? 'war circleNotClicked opaque' : 'dispute circleNotClicked'})

	boardSVG_circle.attr('height', function(d){return data.length*40.2+7});
	boardSVG.attr('height', function(d){return data.length*40.2+7});	

	d3.select('.timezoom').attr('height', function(d){return data.length*40.2+7} )


	allCircles = boardSVG_circle.selectAll('circle').data(data.sort(sortByDateAscending), function(d){return d.DispNum})

	allCircles.attr('style',null).attr('class', function(d){return d.war==0?'circleDrawn':'circleDrawn_war'})
	.transition().duration(1000)
	.attr('cy', function(d,i){return i*40 + 25} )
	.style('stroke',function(d){return d3.select(this).classed('circleDrawn')? '#fff' : '#014e66'  });


	allCircles.enter().append('circle').attr('class', function(d){return d.war==0?'circleDrawn':'circleDrawn_war'}).attr('cx', 30).attr('cy', function(d,i){return i*40 + 25} ).attr('r',0).style('stroke',function(d){return d3.select(this).classed('circleDrawn')? '#fff' : '#014e66'  })
		.on('mouseover', mouseoverCircle_board)
		.on('mouseout', mouseoutCircle_board)
		.on('click', selectCircle_board)
	    .transition()
		.duration(1000)
		.attr('r', 12);

	allRects = timeRectsG.selectAll('rect').data(data.sort(sortByDateAscending), function(d){return d.DispNum}).attr('class', 't_rects');

	allRects.transition().duration(1000).attr('y',function(d,i){return i*40+12.5});

	allRects.enter().append('rect').attr('x', function(d){return newScale==undefined ? timeScale(parseTime(d.Start)) : newScale(parseTime(d.Start))})
	.attr('width', 0)
	.attr('y', function(d,i){return i*40 + 12.5})
	.attr('class', 't_rects')
	.transition()
	.duration(700)
	.attr('width',
		 function(d){return newScale == undefined? d3.max([timeScale(parseTime(d.End)) - timeScale(parseTime(d.Start)),1]) : d3.max([newScale(parseTime(d.End)) - newScale(parseTime(d.Start)),1])})
	
	.attr('height', 24)

	// brushableG.select('.selection').style('height', data.length*40.2+7 );
	// brushableG.select('.handle').style('height', data.length*40.2+7 );
}

function drawLegends(){

	// var myLegends = ['default', 'highlighted', 'intersected', 'clicked', 'filtered']
	// legends.selectAll('circle').data(myLegends)

	legends.selectAll('.legend_dispute,.legend_war').remove();

	legends.append('circle').attr('r', 7).attr('cx', 20).attr('cy', 30).classed('legend_dispute dispute', true);
	legends.append('text').classed('legend_dispute', true).text('Dispute').attr('x',35).attr('y',34);
	legends.append('circle').attr('r', 6).attr('cx', 120).attr('cy', 30).classed('legend_war war', true)
	legends.append('text').classed('legend_war',true).text('War').attr('x',135).attr('y',34);
 	
}
</script>

	
</body>
</html>